# 画像出力時における Legend と Icon の影に関する調査レポート

## 1. 報告内容の概要
ユーザーより、画像出力を行った際に Legend（凡例）と Icon（アイコン）に意図しない影が発生するという報告を受け、その原因の調査と対策を行いました。

## 2. 調査結果
特定のブラウザ環境（特に Safari や iOS デバイス）において、`html-to-image` ライブラリを使用した画像生成時に、CSS の特定のプロパティが正常にレンダリングされないことが判明しました。

### 主な原因
1. **`backdrop-filter` (backdrop-blur-sm) のレンダリング不備**
   Legend に使用されている `backdrop-blur-sm` は、SVG の `foreignObject` を介したレンダリングにおいて不安定です。一部のブラウザでは、ブラー効果を計算できず、代わりに黒やグレーの領域として描画されたり、境界に影のようなノイズが発生します。

2. **`box-shadow` と `border-radius` (rounded-full) の干渉**
   Tailwind CSS の `shadow-*` ユーティリティは、複数の `box-shadow` を重ねて影を表現しています。アイコンのような完全な円形要素（`rounded-full`）に対してこれらを適用すると、SVG エンジンが影の合成に失敗し、不自然に濃い影や「汚れ」のような描画が生じることがあります。

3. **Tailwind CSS v4 の CSS 変数依存**
   Tailwind 4 では影の定義に CSS 変数が多用されています。画像キャプチャ時にこれらの変数が正しく解決されない環境では、デフォルトの不自然な影が適用される可能性があります。

## 3. 修正方針
画像出力（`isExporting` 状態）の際、レンダリングを不安定にする要因を一時的に除去・簡略化することで、すべての環境で一貫した高品質な画像を出力できるようにします。

### 具体的な修正内容
- **Legend:**
  - `backdrop-blur-sm` を無効化
  - 背景を半透明 (`bg-white/80`) から完全不透明 (`bg-white`) に変更
  - `shadow-sm` を除去
- **Icon:**
  - `shadow-md` を除去（出力画像では境界の `border` のみで表現）
- **コンテナ:**
  - 書き出し対象のコンテナ自体の `shadow-lg` を除去

## 4. 期待される効果
この修正により、ブラウザのレンダリングエンジンの制約を受けることなく、クリーンでノイズのない画像出力が可能になります。
