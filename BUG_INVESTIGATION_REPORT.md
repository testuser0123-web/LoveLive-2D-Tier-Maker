# 5種類以上のフォルダから画像を追加した際の出力失敗に関する調査レポート

## 1. 報告内容の概要
5種類以上の異なるフォルダからアイコンを追加して画像出力（PNG保存）を行うと、処理が失敗またはフリーズするというバグについて調査を行いました。

## 2. 調査結果と推測される原因

### 2.1 特殊文字を含むパスのエンコーディング問題
現在の実装では、フォルダ名に日本語（`虹ヶ咲`, `蓮ノ空`, `イキヅライブ`）や記号（`μ's`, `Liella!`）が含まれています。
`html-to-image` ライブラリは、画像をキャンバスに描画するために全ての外部リソースを Data URL に変換しようとしますが、以下のパスで問題が発生している可能性があります。

- **`μ's`**: シングルクォート (`'`) が含まれており、CSS の `url()` や文字列処理でエスケープが不完全な場合、リソースの取得に失敗します。
- **日本語フォルダ名**: ブラウザ環境やライブラリの内部処理において、URL エンコード（`encodeURI`）が二重にかかったり、逆に変換されないまま渡されることで、画像が見つからない（404）扱いになるケースがあります。

### 2.2 リソース同時読み込みの制限とタイムアウト
`html-to-image` は、画像を出力する直前に全てのリソースを再取得します。
- 5種類以上のフォルダから画像を追加すると、参照するフォルダ数（ドメインあたりの同時接続数に近い挙動）が増え、ブラウザのリソース読み込みキューが詰まる可能性があります。
- 現在、`exportImage` 関数内には `300ms` の待機時間がありますが、多数のフォルダにまたがるリソースの Data URL 変換がこの時間内に完了せず、不完全な状態でレンダリングが試行されている可能性があります。

### 2.3 `cacheBust: true` による影響
`next.config.ts` で画像に強力なキャッシュヘッダーを追加しましたが、`exportImage` 時のオプションで `cacheBust: true` が指定されています。
- これにより、出力のたびに全ての画像（特に多フォルダに分散したもの）を強制的に再取得するため、ネットワークレイテンシが増大し、処理の失敗率を高めています。

### 2.4 メモリ使用量の増大
フォルダ数が増える＝アイコンのバリエーションが増える傾向にあり、それら全てを Data URL (Base64) に変換してメモリ上に保持するため、特にモバイル端末やスペックの低い PC ではブラウザのメモリ上限に達し、プロセスがクラッシュしている可能性があります。

## 3. 今後の修正方針（案）
※今回は調査のみのため、実装は行いません。

1. **パスの安全なハンドリング**: アイコン取得 API またはフロントエンド側で、リソースパスを常に `encodeURI` で保護する。
2. **待機時間の調整**: 画像のプリロード（読み込み完了待機）をより厳密に行うロジックの導入。
3. **`cacheBust` の見直し**: キャッシュを有効活用し、再取得のコストを下げる。
4. **Data URL 変換の最適化**: 変換に失敗したリソースをスキップするか、代替手段を検討する。
